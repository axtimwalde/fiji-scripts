import ij.*;
import ij.process.*;
import mpicbg.trakem2.transform.*;
import mpicbg.ij.util.*;
import mpicbg.models.Model;
import mpicbg.models.Point;
import mpicbg.models.PointMatch;

w = 256;
h = 216;
max = 5;
pWidth = 2560;
pHeight = 2160;

transforms = new String[][][][]
{
	{
		{
			{"lenscorrection.NonLinearTransform", "5 21 679.3258256255087 -5.000400635909137 11.115687645496175 592.6066612682761 -7.745959619642675 10.519913944482246 -6.800047038675602 -3.3891150717971597 -8.331791806953477 -7.818297780248779 -4.471745489495415 -7.697050659949189 -6.068500315314592 -0.6246549789415651 -0.13030282622114453 -8.666937454282372 -3.1016793221042605 4.004147051563027 15.536560995288 2.636824142134527 4.855659675661471 6.457934470017811 6.9950171731946185 7.007904687916912 3.8924456518230564 2.4846299911902094 2.518555297986069 3.9075048972239195 -5.544789527135293 -0.277877201916451 -0.607101556756959 -2.3475110341426144 -3.156250650334357 -0.9282421158741454 -0.6273909272456162 -2.8545038023073905 -1.3379988375750107 0.7236031587673948 -0.4027137973141974 -1.9007678361407225 12.97958185076382 10.20607994086357 1297.9607206072924 1020.6089099371947 2138590.361853555 1317747.545812614 1386712.2709461162 3.9588696569239054E9 2.1674666213363576E9 1.7917651250221736E9 2.1440042458124082E9 7.845842164013454E12 4.0090038234660596E12 2.9457818678449707E12 2.7751967002590024E12 3.5695390039368896E12 1.6259781732631242E16 7.94046520472877E15 5.445389585731564E15 4.561884937785705E15 4.630340412027398E15 6.2344092614939E15 100.0 673.7137952800592 587.4276169285929 1808946.509597075 1099694.7141934247 1283189.4441245652 4.370462014913389E9 2.466024530574211E9 2.0979505293963575E9 2.5809944625607486E9 1.039570346470852E13 5.620886579437854E12 4.3729813199806064E12 4.0539902207542676E12 5.151810216585068E12 2.4740970974312336E16 1.2997474013634824E16 9.64548939294495E15 8.199708910997078E15 7.954543273446264E15 1.032647447645786E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "1.0170854 -0.0025234101 -0.0019224511 1.0275205 0.0 0.0"}
		},
		{
			{"lenscorrection.NonLinearTransform", "5 21 675.4123174331603 3.588062725758571 4.230646633764574 590.3809431236086 -4.155943051389433 0.6147150387441842 0.8626963749244028 0.5415285226243508 -5.83300292777259 -2.9821202874212207 -5.714523674115185 -8.483803033458097 -4.46299722959371 0.3287405706927915 -0.19023061492225346 -10.181117924027927 -2.4603154129614753 -3.4555525687867736 12.646403900438665 4.52557530433375 4.728572186149343 4.458654100116342 4.853994083400423 3.3523115573734774 1.6630784395697709 6.96053864854127 2.589233114403953 6.206134456782057 -4.626335883541077 -0.7685871074031112 -0.10468471305337657 -3.359827141208992 -4.3316599676565 0.9608921341802185 0.6732360450323477 -2.837015087518787 -1.0192037443596378 -0.859548019023989 -0.416648108266058 -2.261411674331492 13.998528974235027 11.6738249959893 1399.8542110495678 1167.3812217237737 2414645.793587989 1626901.7910340512 1707009.9960155117 4.604688005058675E9 2.802054880321992E9 2.373187660286568E9 2.7629627879123607E9 9.318229419246123E12 5.339587297187525E12 4.0808574884736255E12 3.8353503126332363E12 4.745985358261679E12 1.9614434931528928E16 1.079906222272027E16 7.766968469366639E15 6.586631947304662E15 6.580702585516234E15 8.478060618035131E15 100.0 674.5781864933831 586.7132193016096 1867546.120021435 1197519.7536387404 1353554.3101859319 4.610705487435882E9 2.800086933751044E9 2.3785606399609876E9 2.8172730046576877E9 1.1138913978910684E13 6.539906238951457E12 5.157378778079057E12 4.712793862114658E12 5.752429113445472E12 2.6820354666274428E16 1.5371951944548454E16 1.1644021615896832E16 9.884544514401868E15 9.393885395081954E15 1.1715140585094544E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "0.9892148 0.010201672 -0.0029152087 0.98763627 0.0 0.0"}
		},
		{
			{"lenscorrection.NonLinearTransform", "5 21 672.9475058313745 -7.609342456280625 -2.388533220063888 600.6247841370385 4.461917746848024 16.156102761321947 -1.8837965875748597 -8.461652636813852 0.534773555042487 -5.483259100727935 -6.018729264081222 -6.230016306394731 -0.9947365510709623 0.013698931169616846 2.2382477906030167 -5.904537842634669 -0.9919607768890897 -1.6030336048492972 11.39226994750602 1.0988404950731783 1.2280744016047018 4.375698622683484 0.1552371951380369 7.027184129593045 4.179753136832773 0.7388020403108563 0.45926500410649407 5.369386047850877 -3.9053917550315944 0.13131583249154555 -0.39920336747596097 -1.3907781060433373 0.05580656184892524 -2.2990836929982863 -0.6424154978911414 -1.3180830622169926 -1.514371214807785 0.7732143079823075 0.47126414399396976 -2.2168729984438666 13.322387964036068 10.889917404475328 1332.2395975483741 1088.9941608444033 2235843.6648559505 1451109.8989845864 1535297.4291683661 4.1933557924123745E9 2.4286029778693285E9 2.047747968991165E9 2.4285635418834987E9 8.393500333345055E12 4.542605012691365E12 3.421168580448565E12 3.2431146970679297E12 4.104892791434831E12 1.753460083726934E16 9.071609271660974E15 6.386837868852244E15 5.411437443451537E15 5.489422591517888E15 7.244785621804735E15 100.0 678.9574857287087 591.0927364943898 1842421.7169050812 1146932.5175705664 1322029.4930326461 4.490968622461962E9 2.614229617836688E9 2.2266403758179755E9 2.698514196699028E9 1.0757675050630557E13 6.021237814444394E12 4.708714920929856E12 4.3501873380957905E12 5.435895554570984E12 2.5745056089812064E16 1.4027719604658042E16 1.048389721501431E16 8.90539565011251E15 8.591773583193421E15 1.0957700465431472E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "0.98197013 -0.012469665 -0.0048117535 0.9929155 0.0 0.0"}
		},
		{
			{"lenscorrection.NonLinearTransform", "5 21 671.2452450620037 4.834836635997278 -6.774208095521221 594.330012384359 -7.905149470802342 -1.4954790721218172 0.32295367500117267 -7.078480913502123 2.061294498219212 -6.905223348307125 5.033958948643863 -2.7408517592495674 1.0918287971876968 4.681085006848879 2.8667518650029633 -0.7822351887164403 0.37199104830347685 -0.4584100516662226 1.7623398767627512 -0.1587381409086348 0.38262624782685517 0.8845505837937517 -0.09331474424920891 1.3548386266072168 2.1183221525931315 -1.7556296524538246 -0.23083344385551882 4.220284422295062 -0.8953098795668172 0.005202569220812803 -0.8153170255541922 -0.3124667189830657 0.5301629031950936 -0.046340504284631545 -0.0016978167564906544 -0.47155083078060944 -0.6952774947124808 1.070987159707836 0.3227823810125175 -1.7558270219611192 13.115803051706783 10.243267589997853 1311.5812842185726 1024.3295182851452 2171761.1988698244 1336191.6931751375 1393145.465686787 4.02216663169663E9 2.2015814644976826E9 1.8070066321424196E9 2.152326528104722E9 7.959498237514582E12 4.059343745676186E12 2.9596637828096943E12 2.7770193048733853E12 3.5780873065346284E12 1.6462049388445684E16 8.000594147813958E15 5.426416178326526E15 4.522869841831747E15 4.59408001612827E15 6.238377491685048E15 100.0 671.9505261205752 586.4263433561832 1800823.224810714 1083632.8530489898 1279546.5826430775 4.354487570104873E9 2.4066182875110373E9 2.0439405235159802E9 2.571411077534759E9 1.0374781150345898E13 5.451164730427292E12 4.178211274240287E12 3.905551234493096E12 5.127270398427982E12 2.4742546248842576E16 1.255229543397384E16 9.077090857884786E15 7.680920179677112E15 7.5800669771549E15 1.0266163668665114E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "1.0107306 0.0040836665 0.009262819 0.9893995 0.0 0.0"}
		}
	},
	{
		{
			{"lenscorrection.NonLinearTransform", "5 21 713.180841400678 -3.856111921475515 13.727826859472795 621.5020351574308 -14.389032212288443 8.703746158828686 -11.29546386432809 -5.1953226538381525 -16.364945299796727 -11.14026728206896 6.0300093597450095 -6.63692545328204 -1.038418023458683 0.9355021589348986 5.583324647120383 -4.9012239236301225 11.507634686038813 8.118004199406197 5.817819181183829 2.6829171807589542 1.4974222044444199 5.820564077559725 2.330923380240568 4.4511052415859265 0.7215987726895334 0.29932186134333527 -10.893616736976464 1.9097354446935597 -2.1529735395067826 -0.6196842319954008 0.32969228739073153 -2.129822115171663 -1.9678735174289084 -0.6369039835564863 0.8001786252503036 -1.7548663913214588 -0.9504343774037176 0.916307335184428 4.404465751928805 -1.333077388648018 11.889026543970987 10.67847173908168 1188.90352334662 1067.8479811421296 1909587.0442207262 1259933.7471240805 1519322.3094940044 3.5047883910111513E9 2.016477757345315E9 1.7900777170112178E9 2.4356940987597446E9 6.938952618092005E12 3.68805815471995E12 2.858070916384949E12 2.867412023884761E12 4.1757785689343955E12 1.442786906137676E16 7.276662507501788E15 5.214571779372001E15 4.567977725244431E15 4.913280428641056E15 7.475022710424039E15 100.0 704.3538173352233 615.6601297839702 1814539.885948734 1127247.148109731 1366568.4107449423 4.330269285949286E9 2.489893810572492E9 2.1464782476231344E9 2.8024357603199E9 1.0269285095399062E13 5.645222029054886E12 4.435716364780421E12 4.181497978630099E12 5.684883199366192E12 2.4443262205781348E16 1.3056977512005658E16 9.77291559797257E15 8.38099152883205E15 8.278833064141963E15 1.1536619986855802E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "1.0073458 0.0062211915 -0.006273767 1.0096823 0.0 0.0"}
		},
		{
			{"lenscorrection.NonLinearTransform", "5 21 717.8265123734592 4.808344414216654 5.245385603191935 621.811951447814 -7.115393549787468 0.30845011916584264 -1.269059730575692 -1.723587122834526 -5.575686343210217 -5.885202921689392 -1.5290089787700865 -8.998914027664444 -4.050184321822195 1.6808737996259195 5.163535545919613 -6.3462687687423545 -6.124129445487235 -0.41534297848996066 8.100032875517368 5.86298218413474 8.034824517451177 2.611128333569915 0.12765442044807607 1.3491090222697908 -2.306312490908315 2.717306624406362 6.879632523100202 6.379328845677514 -2.4901508702242543 -1.417165674937265 -1.9610615888250287 -2.8450807827842275 -3.9077112398874903 1.3824367567138618 2.635691426866412 -1.5658109373196096 -0.1510962330388388 0.4702919781273569 -1.9821334235472978 -3.174189375578151 13.697777106020645 11.615466080422024 1369.7781967508686 1161.5452265928823 2388311.538836855 1584234.7733001926 1729309.2032053296 4.623817764187146E9 2.752977267838452E9 2.3538978307768927E9 2.846944954739627E9 9.505671626498303E12 5.320350853270881E12 4.0813670335223867E12 3.872419803101486E12 4.962393813964659E12 2.0314574967242576E16 1.0929628234093892E16 7.876010609373819E15 6.705726470867713E15 6.748231566372398E15 8.982269830429528E15 100.0 715.5699342594045 616.5529616979805 1949819.5519674348 1253647.4706844015 1404266.625268028 4.817453142115794E9 2.9303312803043456E9 2.4771445599442606E9 2.931854879570342E9 1.1662877284107756E13 6.890170814323256E12 5.430589966411752E12 4.92508809801464E12 6.031448424132182E12 2.8105513066522204E16 1.6298614649309268E16 1.2417128663664922E16 1.0490389702129304E16 9.882412572768458E15 1.2381296285053444E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "0.97882307 0.01740462 -0.009995014 0.97285855 0.0 0.0"}
		},
		{
			{"lenscorrection.NonLinearTransform", "5 21 706.2625046422031 -4.872377313272759 -0.8525637144948588 618.6208958043385 0.5146624275065577 11.098285726478958 -3.815603615235773 -9.025343120355961 -1.3540302850305999 -5.657075718316289 -0.4479478366507621 -0.22191531386804542 -1.0405278565331244 2.711601576348844 1.598911134902604 -5.94640744717077 4.846620354788101 0.7764919715042851 7.219040730275815 -3.900184921444538 0.08570856103754299 1.2688628918282152 1.4512348488777924 5.112568340114139 3.53185453396231 1.8763430154724556 -5.159381001690264 2.8943578628624493 -2.728906907146513 1.6425139802339839 0.7872273496922952 -0.06931310915678357 -1.0454182157878318 -1.835132486918825 -0.09882516549332854 -0.7170222521494902 -1.4294092627298696 -0.09776305347337066 2.4241044071845117 -1.1554903114189141 14.070438671784945 10.31832058586394 1407.0452136403758 1031.8341762138646 2482877.2953066924 1459509.6116451647 1436569.8011569667 4.8271028973124075E9 2.568108558284042E9 2.0440439065872786E9 2.2726897945713024E9 9.925887933531992E12 4.972362772310486E12 3.5966241001949995E12 3.250980434801792E12 3.8570513959789277E12 2.1180111062656188E16 1.0183131197639672E16 6.954565261833658E15 5.724048091805925E15 5.5446027619934E15 6.840671652187391E15 100.0 709.310299625742 609.8383774980693 1939422.1002932074 1210997.194167417 1339175.131289469 4.804970162049393E9 2.7610574089380283E9 2.364962355665867E9 2.708591446885867E9 1.1664047124106578E13 6.405127224606192E12 5.060958860833378E12 4.630752571202675E12 5.425399882855415E12 2.81757486780574E16 1.5029006933938236E16 1.1369775049080962E16 9.669608474859584E15 9.154327056413994E15 1.0892440860145302E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "0.97107774 -0.0032383315 -0.00438415 0.98119575 0.0 0.0"}
		},
		{
			{"lenscorrection.NonLinearTransform", "5 21 712.428441541412 7.019278577203162 -5.101981700061064 614.2418170422778 -10.39849596576169 -1.7193652612336094 -1.1441556860423048 -7.224692026041635 1.5333047004544227 -11.007180883419647 8.213846009203415 -3.504204743548596 1.6228484909713536 1.9836083466180838 2.0535200903342528 -2.611246630918282 0.1165433780497267 11.208854455567556 -0.37395190221290164 -0.8486327274686652 -0.5763902216528258 3.381992714749515 0.6701926027184761 2.1695796040217954 3.259264998152503 0.040637739563286424 0.23310713061718502 -8.59738474524282 -0.3267584291346175 0.5622817486912531 -0.24656991121425165 -0.9480770496115164 0.6114213046556465 -0.5902597816634909 -0.5771566330511391 -0.6276248712892594 -1.2238995045127332 0.2597552961634854 0.16804235803799372 3.3547809650670084 13.151343100273657 10.617595710655475 1315.134452906261 1061.7611433974912 2235632.691435097 1391233.4410888285 1493506.1012871745 4.2546933883144937E9 2.353097830886139E9 1.9483623626980567E9 2.3693841852183356E9 8.638912235376678E12 4.453933786349962E12 3.277249866045148E12 3.07841854360782E12 4.0169706903444897E12 1.8292631708265788E16 8.996047471340353E15 6.168288731350628E15 5.152356846373471E15 5.199392460980474E15 7.103683539337855E15 100.0 711.3895856209184 605.1319103323247 1908143.1730593909 1158350.2360869315 1336594.4152650253 4.665954291261526E9 2.6184701669650702E9 2.2061046359067745E9 2.7057612185306797E9 1.1224934090312135E13 6.027161403464252E12 4.627244543391616E12 4.24352824345219E12 5.419701710463061E12 2.69424190710321E16 1.4051291563235032E16 1.0266551701623784E16 8.591466229489699E15 8.272472151887246E15 1.0879238438809028E16 0.0 2560 2160 "},
			{"mpicbg.trakem2.transform.AffineModel2D", "0.99513286 0.0063953227 0.002148673 0.97665924 0.0 0.0"}
		}
	}
};


ImageProcessor visualizeDifference(int w, int h, CoordinateTransform ct1, CoordinateTransform ct2) {
	FloatProcessor  ip = new FloatProcessor(w, h);
	for (int y = 0; y < h; ++y) {
		for (int x = 0; x < w; ++x) {
			float[] l1 = new float[]{x * sx, y * sy};
			float[] l2 = new float[]{x * sx, y * sy};
			ct1.applyInPlace(l1);
			ct2.applyInPlace(l2);
			double dx = l1[0] - l2[0];
			double dy = l1[1] - l2[1];
			double d = Math.sqrt(dx * dx + dy * dy);
			ip.setf(x, y, (float)d);
		}
	}
	//matrix.copyBits( ip, i * 256, j * 256, Blitter.COPY );
	return ip;
}

ImageProcessor visualizeDifferenceVectors(int w, int h, CoordinateTransform ct1, CoordinateTransform ct2, int max) {
	ColorProcessor ip = new ColorProcessor(w, h);
	for (int y = 0; y < h; ++y) {
		for (int x = 0; x < w; ++x) {
			float[] l1 = new float[]{x * sx, y * sy};
			float[] l2 = new float[]{x * sx, y * sy};
			ct1.applyInPlace(l1);
			ct2.applyInPlace(l2);
			float dx = (l1[0] - l2[0] ) / max;
			float dy = (l1[1] - l2[1] ) / max;
			ip.set(x, y, mpicbg.ij.util.Util.colorVector(dx, dy));
		}
	}
	return ip;
}

Model sampleModel(CoordinateTransform ct, Class modelClass, int width, int height) {
	model = modelClass.newInstance();
	matches = new ArrayList();
	float scaleX = ((float)width - 1.0f) / 63.0f;
	float scaleY = ((float)height - 1.0f) / 63.0f;
	for (int y = 0; y < 64; ++y) {
		float ys = scaleY * y;
		for (int x = 0; x < 64; ++x) {
			float xs = scaleX * x;
			Point p = new Point(new float[]{xs, ys});
			p.apply(ct);
			matches.add(new PointMatch(p, p));
		}
	}
	model.fit(matches);
	return model;
}

/**
 * Estimate a transformation model between two CoordinateTransforms.
 * The model maps ct1 into ct2.
 */
Model sampleModel2(CoordinateTransform ct1, CoordinateTransform ct2, Class modelClass, int width, int height) {
	model = modelClass.newInstance();
	matches = new ArrayList();
	float scaleX = ((float)width - 1.0f) / 63.0f;
	float scaleY = ((float)height - 1.0f) / 63.0f;
	for (int y = 0; y < 64; ++y) {
		float ys = scaleY * y;
		for (int x = 0; x < 64; ++x) {
			float xs = scaleX * x;
			Point p = new Point(new float[]{xs, ys});
			Point q = new Point(new float[]{xs, ys});
			ct1.applyInPlace(p.getL());
			q.apply(ct2);
			matches.add(new PointMatch(p, q));
		}
	}
	model.fit(matches);
	return model;
}


CoordinateTransform createTransform(String className, String dataString) {
	CoordinateTransform ct = (CoordinateTransform)Class.forName(className).newInstance();
	ct.init(dataString);
	return ct;
}


for (int i = 0; i < transforms[ 0 ].length; ++i) {
	ct1 = new CoordinateTransformList();
	for (String[] spec : transforms[0][i])
		ct1.add(createTransform(spec[0], spec[1]));
	ct2 = new CoordinateTransformList();
	for (String[] spec : transforms[1][i])
		ct2.add(createTransform(spec[0], spec[1]));
		
	sx = (double)pWidth / w;
	sy = (double)pHeight / h;


	/* fit a simple linear model to compare with using some transferred samples */
	t = sampleModel2(ct1, ct2, AffineModel2D.class, pWidth, pHeight);
	ct1.add(t);

	new ImagePlus("patch deformation vectors camera " + i, visualizeDifferenceVectors(w, h, ct1, ct2, max)).show();
	new ImagePlus("patch deformation amplitudes camera " + i, visualizeDifference(w, h, ct1, ct2)).show();
}

